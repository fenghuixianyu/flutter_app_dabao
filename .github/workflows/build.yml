name: Flutter Build Release
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'

      # 1. ç”Ÿæˆå®‰å“å·¥ç¨‹
      - name: Create Android Project if Missing
        run: |
          if [ ! -d "android" ]; then
            echo "âš ï¸ Generating Android scaffold..."
            # å¼ºåˆ¶æŒ‡å®šé¡¹ç›®åä¸º my_diary_appï¼Œé˜²æ­¢æ–‡ä»¶å¤¹åå­—æŠ¥é”™
            flutter create . --platforms android --project-name my_diary_app
          fi

      # 2. ğŸ’‰ã€å…³é”®ä¿®å¤ã€‘ä¿®æ”¹ build.gradle æå‡æœ€ä½ç‰ˆæœ¬
      # è¿™ä¸€æ­¥ä¸“é—¨è§£å†³ share_plus å¯¼è‡´çš„æŠ¥é”™
      - name: Fix minSdkVersion
        run: |
          # ä½¿ç”¨ sed å‘½ä»¤æŠŠé»˜è®¤ç‰ˆæœ¬å·æ›¿æ¢æˆ 21
          sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 21/g' android/app/build.gradle
          echo "âœ… MinSDK fixed to 21"

      - name: Install Dependencies
        run: flutter pub get

      # 3. ğŸ”‘ ç”Ÿæˆä¸´æ—¶ç­¾åå¯†é’¥ (ä¸ºäº†èƒ½æ‰“ Release åŒ…)
      - name: Generate Keystore
        run: |
          keytool -genkey -v -keystore upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload -dname "CN=Android, OU=Android, O=Android, L=Android, S=Android, C=US" \
            -storepass android -keypass android
          
          # ç”Ÿæˆé…ç½®æ–‡ä»¶å‘Šè¯‰ Flutter å¯†é’¥åœ¨å“ª
          echo "storePassword=android" > android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=../../upload-keystore.jks" >> android/key.properties

      # 4. âœ¨ æé€Ÿæ‰“åŒ… (Release + ARM64)
      # è¿™æ¬¡ä¼šç”Ÿæˆä½“ç§¯æœ€å°çš„åŒ…
      - name: Build APK
        run: flutter build apk --release --target-platform android-arm64

      # 5. ä¸Šä¼  APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: diary-app-release
          path: build/app/outputs/flutter-apk/app-release.apk
